<!DOCTYPE html>
<html lang="id" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Counter Viewer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --digit-on: #00ffcc;
      --digit-off: rgba(0, 255, 204, 0.1);
    }
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--bs-body-bg);
    }
    .viewer-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }
    .counter-display {
      text-align: center;
      max-width: 100%;
    }
    .counter-title {
      font-size: clamp(1.5rem, 5vw, 3rem);
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: var(--bs-emphasis-color);
    }
    .counter-title:empty {
      display: none;
    }
    .counter-note {
      font-size: clamp(0.9rem, 2vw, 1.2rem);
      color: var(--bs-secondary-color);
      margin-bottom: 1rem;
      font-style: italic;
    }
    .counter-note:empty {
      display: none;
    }
    .counter-value {
      font-size: clamp(4rem, 20vw, 15rem);
      font-weight: bold;
      line-height: 1;
      color: var(--digit-on);
      text-shadow: 0 0 30px rgba(0, 255, 204, 0.5);
    }
    .counter-goal {
      font-size: clamp(1rem, 3vw, 2rem);
      color: var(--bs-secondary-color);
      margin-top: 0.5rem;
    }
    .counter-addon {
      font-size: clamp(1.5rem, 5vw, 3rem);
      color: var(--bs-warning);
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      background: rgba(255, 193, 7, 0.1);
      border-radius: 0.5rem;
    }
    .progress-container {
      width: 100%;
      max-width: 600px;
      margin-top: 1rem;
    }
    .controls {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 0.5rem;
      z-index: 1000;
      align-items: center;
    }
    .remote-controls {
      gap: 0.5rem;
      align-items: center;
    }
    .seven-seg {
      display: inline-flex;
      gap: 4px;
    }
    .digit {
      width: clamp(30px, 8vw, 80px);
      height: clamp(50px, 14vw, 140px);
      position: relative;
    }
    .digit .seg {
      position: absolute;
      background: var(--digit-off);
      border-radius: 2px;
      transition: background 0.1s;
    }
    .digit .seg.on { background: var(--digit-on); box-shadow: 0 0 8px var(--digit-on); }
    .digit .seg-a { width: 60%; height: 8%; left: 20%; top: 0; }
    .digit .seg-b { width: 8%; height: 40%; right: 10%; top: 8%; }
    .digit .seg-c { width: 8%; height: 40%; right: 10%; top: 52%; }
    .digit .seg-d { width: 60%; height: 8%; left: 20%; bottom: 0; }
    .digit .seg-e { width: 8%; height: 40%; left: 10%; top: 52%; }
    .digit .seg-f { width: 8%; height: 40%; left: 10%; top: 8%; }
    .digit .seg-g { width: 60%; height: 8%; left: 20%; top: 46%; }

    .status-badge {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1000;
    }
    
    .goal-reached .counter-value {
      animation: pulse 1s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 4px solid var(--digit-off);
      border-top-color: var(--digit-on);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (display-mode: picture-in-picture) {
      body { padding: 0.5rem; }
      .controls { display: none; }
      .status-badge { display: none; }
      .counter-title { font-size: 1.2rem; }
      .counter-value { font-size: 4rem; }
      .counter-goal { font-size: 1rem; }
    }
  </style>
</head>
<body>

<div class="status-badge">
  <span class="badge bg-secondary" id="connectionStatus">
    <span class="spinner-border spinner-border-sm me-1"></span>Loading...
  </span>
</div>

<div class="viewer-container" id="viewerContainer">
  <div class="counter-display" id="counterDisplay">
    <div class="counter-title" id="counterTitle"></div>
    <div class="counter-note" id="counterNote"></div>
    <div class="counter-value" id="counterValue">
      <div class="loading-spinner mx-auto"></div>
    </div>
    <div class="counter-goal d-none" id="counterGoal"></div>
    <div class="progress-container d-none" id="progressContainer">
      <div class="progress" style="height: 10px;">
        <div class="progress-bar bg-success" id="progressBar" style="width: 0%;"></div>
      </div>
    </div>
    <div class="counter-addon d-none" id="counterAddon"></div>
  </div>
</div>

<div class="controls" id="controlsContainer">
  <div class="remote-controls d-none" id="remoteControls">
    <button class="btn btn-outline-light btn-lg" id="btnMinus" title="Kurang">
      <i class="bi bi-dash-lg"></i>
    </button>
    <button class="btn btn-outline-light btn-lg" id="btnPlus" title="Tambah">
      <i class="bi bi-plus-lg"></i>
    </button>
    <button class="btn btn-outline-warning btn-lg" id="btnReset" title="Reset">
      <i class="bi bi-arrow-counterclockwise"></i>
    </button>
  </div>
  <button class="btn btn-outline-info btn-lg" id="btnPip" title="Picture-in-Picture (Popup)">
    <i class="bi bi-pip"></i>
  </button>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<!-- Firebase Config -->
<script src="env.js"></script>

<script>
(function() {
  // Parse URL parameters
  const hash = location.hash.slice(1);
  const params = new URLSearchParams(hash);
  
  let sessionId = params.get('session') || '';
  let cardId = params.get('id') || '';
  const remoteControl = params.get('rc') === '1';
  const dataParam = params.get('data');

  console.log('Viewer params:', { sessionId, cardId, remoteControl, hasData: !!dataParam });

  // State
  let currentCard = null;
  let allCards = [];
  let db = null;
  let docRef = null;
  let unsubscribe = null;
  let pipWindow = null;
  let isOfflineMode = false;

  // DOM Elements
  const $ = id => document.getElementById(id);
  const connectionStatus = $('connectionStatus');
  const counterTitle = $('counterTitle');
  const counterNote = $('counterNote');
  const counterValue = $('counterValue');
  const counterGoal = $('counterGoal');
  const counterAddon = $('counterAddon');
  const progressContainer = $('progressContainer');
  const progressBar = $('progressBar');
  const counterDisplay = $('counterDisplay');
  const remoteControls = $('remoteControls');

  const btnMinus = $('btnMinus');
  const btnPlus = $('btnPlus');
  const btnReset = $('btnReset');
  const btnPip = $('btnPip');

  // Seven-segment digit patterns
  const SEGMENT_MAP = {
    '0': 'abcdef', '1': 'bc', '2': 'abdeg', '3': 'abcdg', '4': 'bcfg',
    '5': 'acdfg', '6': 'acdefg', '7': 'abc', '8': 'abcdefg', '9': 'abcdfg'
  };

  function createSevenSegment(numStr) {
    let html = '<div class="seven-seg">';
    for (const ch of numStr) {
      const segs = SEGMENT_MAP[ch] || '';
      html += '<div class="digit">';
      for (const s of 'abcdefg') {
        html += `<div class="seg seg-${s} ${segs.includes(s) ? 'on' : ''}"></div>`;
      }
      html += '</div>';
    }
    html += '</div>';
    return html;
  }

  function formatTime(ms) {
    const totalSec = Math.floor(ms / 1000);
    const h = Math.floor(totalSec / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    const s = totalSec % 60;
    if (h > 0) return `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    return `${m}:${String(s).padStart(2, '0')}`;
  }

  function updateDisplay(card) {
    if (!card) {
      counterTitle.textContent = '';
      counterNote.textContent = '';
      counterValue.innerHTML = '<span class="text-muted">No Data</span>';
      counterGoal.classList.add('d-none');
      progressContainer.classList.add('d-none');
      counterAddon.classList.add('d-none');
      return;
    }

    currentCard = card;
    
    // Title - only show if exists
    counterTitle.textContent = card.title || '';
    
    // Note - only show if exists
    counterNote.textContent = card.note || '';
    
    // Display count with seven-segment
    const countStr = String(card.count || 0);
    counterValue.innerHTML = createSevenSegment(countStr);

    // Goal display
    if (card.goal > 0) {
      counterGoal.classList.remove('d-none');
      counterGoal.textContent = `Target: ${card.count} / ${card.goal}`;
      
      progressContainer.classList.remove('d-none');
      const pct = Math.min(100, (card.count / card.goal) * 100);
      progressBar.style.width = pct + '%';
      
      if (card.count >= card.goal) {
        counterDisplay.classList.add('goal-reached');
        progressBar.classList.remove('bg-success');
        progressBar.classList.add('bg-warning');
        counterGoal.innerHTML = `üéâ Target Tercapai! ${card.count} / ${card.goal}`;
      } else {
        counterDisplay.classList.remove('goal-reached');
        progressBar.classList.remove('bg-warning');
        progressBar.classList.add('bg-success');
      }
    } else {
      counterGoal.classList.add('d-none');
      progressContainer.classList.add('d-none');
      counterDisplay.classList.remove('goal-reached');
    }

    // Addon display (stopwatch/timer)
    if (card.addonType === 'stopwatch') {
      counterAddon.classList.remove('d-none');
      let elapsed = card.swElapsedMs || 0;
      if (card.swRunning && card.swLastTs) {
        elapsed += Date.now() - card.swLastTs;
      }
      const statusIcon = card.swRunning ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
      counterAddon.innerHTML = `<i class="bi bi-stopwatch me-2"></i>${statusIcon} ${formatTime(elapsed)}`;
    } else if (card.addonType === 'timer') {
      counterAddon.classList.remove('d-none');
      let remain = card.tRemainSec || 0;
      if (card.tRunning && card.tLastTs) {
        const elapsed = Math.floor((Date.now() - card.tLastTs) / 1000);
        remain = Math.max(0, remain - elapsed);
      }
      const statusIcon = card.tRunning ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
      counterAddon.innerHTML = `<i class="bi bi-hourglass-split me-2"></i>${statusIcon} ${formatTime(remain * 1000)}`;
    } else {
      counterAddon.classList.add('d-none');
    }

    // Update document title
    document.title = (card.title || 'Counter') + ' - ' + (card.count || 0);

    // Update PiP window if open
    if (pipWindow && !pipWindow.closed) {
      updatePipContent();
    }
  }

  function setStatus(text, type = 'secondary') {
    connectionStatus.className = `badge bg-${type}`;
    connectionStatus.innerHTML = text;
  }

  function handleSnapshot(snap) {
    try {
      if (!snap.exists) {
        setStatus('Waiting...', 'warning');
        counterValue.innerHTML = '<span class="text-warning">Menunggu data...<br><small>Pastikan Sync aktif di aplikasi Counter Board.</small></span>';
        return;
      }

      const data = snap.data();
      if (!data || !data.state) {
        setStatus('Empty data', 'warning');
        counterValue.innerHTML = '<span class="text-warning">Data kosong.<br><small>Buka aplikasi utama dan aktifkan Sync.</small></span>';
        return;
      }

      setStatus('üü¢ Live', 'success');

      // Store all cards for reference
      allCards = data.state.cards || [];
      
      // Find the card
      let card = null;
      if (cardId) {
        card = allCards.find(c => c.id === cardId);
      }
      if (!card && allCards.length > 0) {
        card = allCards[0];
      }
      
      if (!card) {
        counterValue.innerHTML = '<span class="text-muted">Card tidak ditemukan.<br><small>Counter mungkin sudah dihapus.</small></span>';
        return;
      }
      
      updateDisplay(card);
    } catch (e) {
      console.error('Snapshot error:', e);
      setStatus('Parse error', 'danger');
      counterValue.innerHTML = '<span class="text-danger">Gagal memproses data.</span>';
    }
  }

  async function initFirebase() {
    try {
      // Try to get config from env.js
      let config = window.__FIREBASE_CONFIG;
      
      // Fallback to default config
      if (!config) {
        config = {
          apiKey: "AIzaSyDizcJ5Kus-YuS4w4QdFM3rEyHv_vHUHC4",
          authDomain: "counter-controller.firebaseapp.com",
          projectId: "counter-controller",
          storageBucket: "counter-controller.firebasestorage.app",
          messagingSenderId: "98155640507",
          appId: "1:98155640507:web:ee18f7f2be1dcc86691b9e"
        };
      }

      if (!firebase.apps.length) {
        firebase.initializeApp(config);
      }
      db = firebase.firestore();
      return true;
    } catch (e) {
      console.error('Firebase init error:', e);
      setStatus('Firebase error', 'danger');
      return false;
    }
  }

  async function connect() {
    setStatus('<span class="spinner-border spinner-border-sm me-1"></span>Connecting...', 'secondary');
    
    if (!sessionId) {
      setStatus('No session ID', 'danger');
      counterValue.innerHTML = '<span class="text-danger">Session ID tidak ditemukan</span>';
      return;
    }

    if (!await initFirebase()) return;

    try {
      docRef = db.collection('boards').doc(sessionId);
      
      // Subscribe to changes (will handle both exists and not exists cases)
      unsubscribe = docRef.onSnapshot(
        { includeMetadataChanges: true },
        (snap) => {
          if (snap.metadata.fromCache && !snap.exists) {
            // Data from cache, waiting for network
            setStatus('<span class="spinner-border spinner-border-sm me-1"></span>Connecting...', 'warning');
            counterValue.innerHTML = '<span class="text-warning">Menghubungkan ke server...<br><small>Pastikan koneksi internet stabil.</small></span>';
          } else {
            handleSnapshot(snap);
          }
        },
        (err) => {
          console.error('Snapshot error:', err);
          if (err.code === 'permission-denied') {
            setStatus('Access Denied', 'danger');
            counterValue.innerHTML = '<span class="text-danger">Akses ditolak.<br><small>Session ini mungkin dibuat oleh pengguna lain.</small></span>';
          } else if (err.code === 'unavailable') {
            setStatus('Offline', 'warning');
            counterValue.innerHTML = '<span class="text-warning">Server tidak dapat dijangkau.<br><small>Periksa koneksi internet Anda.</small></span>';
          } else {
            setStatus('Error', 'danger');
            counterValue.innerHTML = `<span class="text-danger">Terjadi kesalahan.<br><small>${err.message || 'Unknown error'}</small></span>`;
          }
        }
      );
      
    } catch (e) {
      console.error('Connection error:', e);
      setStatus('Connection failed', 'danger');
      counterValue.innerHTML = '<span class="text-danger">Gagal terhubung ke server<br><small>' + (e.message || '') + '</small></span>';
    }
  }

  // Remote control functions
  async function remoteAction(action) {
    if (isOfflineMode) {
      alert('Remote control tidak tersedia dalam mode offline.');
      return;
    }
    
    if (!docRef || !currentCard) {
      console.log('Cannot perform action: no docRef or currentCard');
      return;
    }
    
    try {
      const snap = await docRef.get();
      if (!snap.exists) {
        console.log('Document does not exist');
        return;
      }

      const data = snap.data();
      const cards = data.state.cards || [];
      const idx = cards.findIndex(c => c.id === currentCard.id);
      if (idx === -1) {
        console.log('Card not found:', currentCard.id);
        return;
      }

      switch (action) {
        case 'plus':
          cards[idx].count = Math.min(1e9, (cards[idx].count || 0) + (cards[idx].step || 1));
          break;
        case 'minus':
          cards[idx].count = Math.max(0, (cards[idx].count || 0) - (cards[idx].step || 1));
          break;
        case 'reset':
          cards[idx].count = 0;
          cards[idx].goalReached = false;
          break;
      }

      // Check goal
      if (cards[idx].goal > 0 && cards[idx].count >= cards[idx].goal) {
        cards[idx].goalReached = true;
      }

      data.state.cards = cards;
      data.ts = Date.now();
      await docRef.set(data, { merge: true });
    } catch (e) {
      console.error('Remote action error:', e);
    }
  }

  // Picture-in-Picture
  async function openPictureInPicture() {
    if ('documentPictureInPicture' in window) {
      try {
        pipWindow = await documentPictureInPicture.requestWindow({
          width: 400,
          height: 300
        });

        // Copy styles
        const styles = document.querySelectorAll('style, link[rel="stylesheet"]');
        styles.forEach(style => {
          pipWindow.document.head.appendChild(style.cloneNode(true));
        });

        // Create content - only show controls if remote control enabled
        const controlsHtml = remoteControl && !isOfflineMode ? `
          <div class="mt-3 d-flex gap-2">
            <button class="btn btn-outline-light" id="pipMinus"><i class="bi bi-dash-lg"></i></button>
            <button class="btn btn-outline-light" id="pipPlus"><i class="bi bi-plus-lg"></i></button>
            <button class="btn btn-outline-warning" id="pipReset"><i class="bi bi-arrow-counterclockwise"></i></button>
          </div>
        ` : '';

        const container = document.createElement('div');
        container.id = 'pipContainer';
        container.style.cssText = 'display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh;padding:1rem;background:var(--bs-body-bg);';
        container.innerHTML = `
          <div class="counter-title" id="pipTitle">${currentCard?.title || ''}</div>
          <div class="counter-value" id="pipValue">${currentCard?.count || 0}</div>
          <div class="counter-goal ${currentCard?.goal > 0 ? '' : 'd-none'}" id="pipGoal">Target: ${currentCard?.count || 0}/${currentCard?.goal || 0}</div>
          ${controlsHtml}
        `;
        pipWindow.document.body.appendChild(container);
        pipWindow.document.body.style.cssText = 'margin:0;background:var(--bs-body-bg);';
        pipWindow.document.documentElement.setAttribute('data-bs-theme', 'dark');

        // Add event listeners only if remote control
        if (remoteControl && !isOfflineMode) {
          pipWindow.document.getElementById('pipMinus')?.addEventListener('click', () => remoteAction('minus'));
          pipWindow.document.getElementById('pipPlus')?.addEventListener('click', () => remoteAction('plus'));
          pipWindow.document.getElementById('pipReset')?.addEventListener('click', () => remoteAction('reset'));
        }

        pipWindow.addEventListener('pagehide', () => {
          pipWindow = null;
        });

        updatePipContent();
      } catch (e) {
        console.error('PiP error:', e);
        openPopupWindow();
      }
    } else {
      openPopupWindow();
    }
  }

  function openPopupWindow() {
    const width = 400;
    const height = 300;
    const left = screen.width - width - 20;
    const top = 20;
    
    pipWindow = window.open(
      location.href,
      'CounterViewer',
      `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=no,toolbar=no,menubar=no,location=no,status=no`
    );
  }

  function updatePipContent() {
    if (!pipWindow || pipWindow.closed || !currentCard) return;

    try {
      const pipTitle = pipWindow.document.getElementById('pipTitle');
      const pipValue = pipWindow.document.getElementById('pipValue');
      const pipGoal = pipWindow.document.getElementById('pipGoal');

      if (pipTitle) pipTitle.textContent = currentCard.title || '';
      if (pipValue) pipValue.innerHTML = createSevenSegment(String(currentCard.count || 0));
      if (pipGoal) {
        if (currentCard.goal > 0) {
          pipGoal.classList.remove('d-none');
          pipGoal.textContent = `Target: ${currentCard.count}/${currentCard.goal}`;
        } else {
          pipGoal.classList.add('d-none');
        }
      }
    } catch (e) {
      // PiP window might be closed
    }
  }

  // Event listeners
  btnMinus.addEventListener('click', () => remoteAction('minus'));
  btnPlus.addEventListener('click', () => remoteAction('plus'));
  btnReset.addEventListener('click', () => {
    if (confirm('Reset counter ke 0?')) {
      remoteAction('reset');
    }
  });
  btnPip.addEventListener('click', openPictureInPicture);

  // Show remote controls only if remote control is enabled
  if (remoteControl) {
    remoteControls.classList.remove('d-none');
    remoteControls.classList.add('d-flex');
  }

  // Update addon display periodically
  setInterval(() => {
    if (currentCard && (currentCard.addonType === 'stopwatch' || currentCard.addonType === 'timer')) {
      updateDisplay(currentCard);
    }
  }, 1000);

  // Initialize
  if (dataParam) {
    // Offline mode - data embedded in URL
    isOfflineMode = true;
    try {
      const json = decodeURIComponent(escape(atob(dataParam)));
      const obj = JSON.parse(json);
      allCards = obj.cards || [];
      
      let card = null;
      if (cardId) {
        card = allCards.find(c => c.id === cardId);
      }
      if (!card && allCards.length > 0) {
        card = allCards[0];
      }
      
      setStatus('üì¥ Offline', 'info');
      updateDisplay(card);
      
      // Disable remote controls in offline mode
      if (remoteControl) {
        btnMinus.disabled = true;
        btnPlus.disabled = true;
        btnReset.disabled = true;
        btnMinus.title = 'Tidak tersedia dalam mode offline';
        btnPlus.title = 'Tidak tersedia dalam mode offline';
        btnReset.title = 'Tidak tersedia dalam mode offline';
      }
    } catch (e) {
      console.error('Data parse error:', e);
      setStatus('Data Error', 'danger');
      counterValue.innerHTML = '<span class="text-danger">Gagal memuat data</span>';
    }
  } else if (sessionId) {
    // Live mode - connect to Firebase
    connect();
  } else {
    // No data source
    setStatus('No Source', 'danger');
    counterValue.innerHTML = '<span class="text-muted">Tidak ada data untuk ditampilkan.<br><small>Buka viewer dari aplikasi Counter Board.</small></span>';
  }
})();
</script>
</body>
</html>
